<!doctype html><html class="h-full antialiased" style=--header-position:sticky;--content-offset:0px;--header-height:64px;--header-mb:0px;--header-top:0px;--avatar-top:0px lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Private API Gateway with DNS - Cino</title><link rel=canonical href=https://cino.io/2024/private-api-gateway-with-dns/><link rel=alternate type=application/rss+xml title=RSS href=https://cino.io/index.xml><link rel=icon type=image/png href=/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=/favicon.svg><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Cino.io"><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://cino.io/2024/private-api-gateway-with-dns/"><meta property="og:site_name" content="Cino"><meta property="og:title" content="Private API Gateway with DNS"><meta property="og:description" content="UPDATE: Ofcourse, after I finalized this article Amazon released native support for Private DNS on API Gateways. . Announced on the AWS Blog.
At PostNL we are building most of our applications with Serverless in mind, let me rephrase that, we build all our applications within our own landing zone with Serverless only. There is no option to deploy any kind of EC2 and if you need containers you’d be running them on Fargate only."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2024"><meta property="article:published_time" content="2024-11-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-17T00:00:00+00:00"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Amazon Web Services"><meta property="article:tag" content="Tags/Api Gateway"><meta property="article:tag" content="Networking"><meta property="article:tag" content="Vpc"><meta property="article:tag" content="Dns"><meta property="og:image" content="https://cino.io/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cino.io/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb.png"><meta name=twitter:title content="Private API Gateway with DNS"><meta name=twitter:description content="UPDATE: Ofcourse, after I finalized this article Amazon released native support for Private DNS on API Gateways. . Announced on the AWS Blog.
At PostNL we are building most of our applications with Serverless in mind, let me rephrase that, we build all our applications within our own landing zone with Serverless only. There is no option to deploy any kind of EC2 and if you need containers you’d be running them on Fargate only."><meta itemprop=name content="Private API Gateway with DNS"><meta itemprop=description content="UPDATE: Ofcourse, after I finalized this article Amazon released native support for Private DNS on API Gateways. . Announced on the AWS Blog.
At PostNL we are building most of our applications with Serverless in mind, let me rephrase that, we build all our applications within our own landing zone with Serverless only. There is no option to deploy any kind of EC2 and if you need containers you’d be running them on Fargate only."><meta itemprop=datePublished content="2024-11-17T00:00:00+00:00"><meta itemprop=dateModified content="2024-11-17T00:00:00+00:00"><meta itemprop=wordCount content="1632"><meta itemprop=image content="https://cino.io/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb.png"><meta itemprop=keywords content="Aws,Amazon Web Services,Tags/Api Gateway,Networking,Vpc,Dns,Vpc Endpoint,Private,Route 53,Application Load Balancer"><link rel=stylesheet href="https://cino.io/css/styles.min.22a35d5eab0e3ecf0d2ceed15f1d08547695057ed928ec4acddf4e7ac8648203.css" integrity="sha256-IqNdXqsOPs8NLO7RXx0IVHaVBX7ZKOxKzd9OeshkggM="><meta name=fediverse:creator content="@cino@fosstodon.org"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GCGJ9S1XSX"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GCGJ9S1XSX")}</script></head><body class="flex h-full flex-col bg-zinc-50"><div class="fixed inset-0 flex justify-center sm:px-8"><div class="flex w-full max-w-7xl lg:px-8"><div class="w-full bg-white ring-1 ring-zinc-100"></div></div></div><div class=relative><header class="pointer-events-none relative z-50 flex flex-col" style=height:var(--header-height);margin-bottom:var(--header-mb)><div class="top-0 z-10 h-16 pt-6" style=position:var(--header-position)><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style=position:var(--header-inner-position)><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><a aria-label=Home class=pointer-events-auto href=https://cino.io/><img alt sizes=2.25rem src=/img/ricardo-cino-36x36.jpg decoding=async data-nimg=1 class="rounded-full bg-zinc-100 object-cover h-9 w-9" style=color:transparent width=512 height=512 alt="Ricardo Cino"></a></div></div><div class="relative flex justify-end flex-1"><div class="mt-2 flex gap-6"><a class="group -m-1 p-1 pointer-events-auto" aria-label="Follow on Bluesky" href=https://bsky.app/profile/cino.io target=_blank><svg viewBox="0 0 24 24" width="24" height="24" class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300"><path style="stroke:none;fill-rule:nonzero" d="M4.550781 2.792969c2.410157 1.773437 5 5.371093 5.949219 7.296875V15.1875C10.5 15.078125 10.457031 15.203125 10.367188 15.464844 9.871094 16.894531 7.929688 22.476562 3.5 18.015625c-2.332031-2.351563-1.253906-4.699219 2.996094-5.40625-2.429688.40625-5.164063-.265625-5.914063-2.894531C.367188 8.960938.0 4.304688.0 3.675781.0.523438 2.816406 1.515625 4.550781 2.792969zm11.898438.0c-2.410157 1.773437-5 5.371093-5.949219 7.296875V15.1875C10.5 15.078125 10.542969 15.203125 10.632812 15.464844 11.128906 16.894531 13.070312 22.476562 17.5 18.015625c2.332031-2.351563 1.253906-4.699219-2.996094-5.40625 2.429688.40625 5.164063-.265625 5.914063-2.894531C20.632812 8.960938 21 4.304688 21 3.675781c0-3.152343-2.816406-2.160156-4.550781-.882812zm0 0"/></svg>
</a><a class="group -m-1 p-1 pointer-events-auto" aria-label="Follow on Mastodon" href=https://fosstodon.org/@cino rel=me target=_blank><svg viewBox="0 0 16 16" aria-hidden="true" class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300"><path fill="#828282" d="M15.659 9.592C15.424 10.72 13.553 11.956 11.404 12.195 10.283 12.32 9.18 12.434 8.003 12.384 6.079 12.302 4.56 11.956 4.56 11.956 4.56 12.13 4.572 12.297 4.595 12.452c.25 1.772 1.883 1.878 3.43 1.927C9.586 14.429 10.976 14.02 10.976 14.02L11.04 15.337S9.948 15.884 8.003 15.984C6.93 16.039 5.598 15.959 4.047 15.576.683 14.746.104 11.4.015 8.006-.012 6.998.005 6.048.005 5.253.005 1.782 2.443.765 2.443.765 3.672.238 5.782.017 7.975.0H8.029c2.192.017 4.303.238 5.532.765.0.0 2.438 1.017 2.438 4.488.0.0.0310000000000006 2.561-.34 4.339zm-2.535-4.07V9.725H11.339V5.646c0-.86-.388-1.296-1.164-1.296C9.317 4.35 8.887 4.867 8.887 5.891V8.124H7.113V5.891C7.113 4.867 6.683 4.35 5.825 4.35c-.776.0-1.164.436-1.164 1.296V9.725H2.876V5.522c0-.859.235-1.541.706-2.046.485-.505 1.121-.764 1.911-.764C6.406 2.712 7.098 3.039 7.555 3.695L8 4.39l.445-.695C8.902 3.039 9.594 2.712 10.507 2.712 11.297 2.712 11.933 2.971 12.418 3.476 12.889 3.981 13.124 4.663 13.124 5.522z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd"/></svg>
</a><a class="group -m-1 p-1 pointer-events-auto" aria-label="Follow on GitHub" href=https://github.com/cino target=_blank><svg viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.475 2 2 6.588 2 12.253c0 4.537 2.862 8.369 6.838 9.727.5.09.687-.218.687-.487.0-.243-.013-1.05-.013-1.91C7 20.059 6.35 18.957 6.15 18.38c-.113-.295-.6-1.205-1.025-1.448-.35-.192-.85-.667-.013-.68.788-.012 1.35.744 1.538 1.051.9 1.551 2.338 1.116 2.912.846.088-.666.35-1.115.638-1.371-2.225-.256-4.55-1.14-4.55-5.062.0-1.115.387-2.038 1.025-2.756-.1-.256-.45-1.307.1-2.717.0.0.837-.269 2.75 1.051.8-.23 1.65-.346 2.5-.346s1.7.115 2.5.346c1.912-1.333 2.75-1.05 2.75-1.05.55 1.409.2 2.46.1 2.716.637.718 1.025 1.628 1.025 2.756.0 3.934-2.337 4.806-4.562 5.062.362.32.675.936.675 1.897.0 1.371-.013 2.473-.013 2.82.0.268.188.589.688.486a10.039 10.039.0 004.932-3.74A10.447 10.447.0 0022 12.253C22 6.588 17.525 2 12 2z"/></svg>
</a><a class="group -m-1 p-1 pointer-events-auto" aria-label="Follow on LinkedIn" href=https://www.linkedin.com/in/cinoricardo/ target=_blank><svg viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300"><path d="M18.335 18.339H15.67v-4.177c0-.996-.02-2.278-1.39-2.278-1.389.0-1.601 1.084-1.601 2.205v4.25h-2.666V9.75h2.56v1.17h.035c.358-.674 1.228-1.387 2.528-1.387 2.7.0 3.2 1.778 3.2 4.091v4.715zM7.003 8.575A1.546 1.546.0 015.455 7.026a1.548 1.548.0 111.547 1.549zm1.336 9.764H5.666V9.75H8.34v8.589zM19.67 3H4.329C3.593 3 3 3.58 3 4.297v15.406C3 20.42 3.594 21 4.328 21h15.338C20.4 21 21 20.42 21 19.703V4.297C21 3.58 20.4 3 19.666 3h.003z"/></svg></a></div></div></div></div></div></div></div></div></header><main><div class="sm:px-8 mt-16 lg:mt-32"><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class=xl:relative><div class="mx-auto max-w-2xl"><a href=/ aria-label="Go back to articles" class="group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:left-0 xl:mt-0"><svg viewBox="0 0 16 16" fill="none" aria-hidden="true" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400"><path d="M7.25 11.25 3.75 8m0 0 3.5-3.25M3.75 8h8.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a><article><header class="flex flex-col"><time datetime=2024-11-17 class="order-first flex items-center text-base text-zinc-400 dark:text-zinc-500"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>November 17, 2024</span>
<span class="h-4 ml-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>8 min read</span></time><div class="relative mt-4 text-zinc-400"><a href=/tags/aws/ class=hover:text-zinc-200>#aws</a>, <a href=/tags/amazon-web-services/ class=hover:text-zinc-200>#amazon web services</a>, <a href=/tags/api-gateway/ class=hover:text-zinc-200>#api gateway</a>, <a href=/tags/networking/ class=hover:text-zinc-200>#networking</a>, <a href=/tags/vpc/ class=hover:text-zinc-200>#vpc</a>, <a href=/tags/dns/ class=hover:text-zinc-200>#dns</a>, <a href=/tags/vpc-endpoint/ class=hover:text-zinc-200>#vpc endpoint</a>, <a href=/tags/private/ class=hover:text-zinc-200>#private</a>, <a href=/tags/route-53/ class=hover:text-zinc-200>#route 53</a>, <a href=/tags/application-load-balancer/ class=hover:text-zinc-200>#application load balancer</a></div><h1 class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">Private API Gateway with DNS</h1></header><div class="mt-8 prose dark:prose-invert"><p><strong>UPDATE:</strong> Ofcourse, after I finalized this article Amazon released native support for <a href=https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-private-custom-domains.html>Private DNS on API Gateways.
</a>. Announced on the <a href=https://aws.amazon.com/blogs/compute/implementing-custom-domain-names-for-private-endpoints-with-amazon-api-gateway/>AWS Blog</a>.</p><p>At PostNL we are building most of our applications with <a href=https://medium.com/postnl-engineering/business-overview-f7c8d8ebee2c>Serverless</a> in mind, let me rephrase that, we build all our applications within our own landing zone with Serverless only. There is no option to deploy any kind of EC2 and if you need containers you&rsquo;d be running them on Fargate only.</p><p>Given that, we are using quite a bunch of API Gateways in the projects I&rsquo;m working on. While PostNL is also a big corporate company we have a strong focus on security and compliance, and that&rsquo;s why we are building our applications <strong>Private first</strong>. When there is no need to be public, it shouldn&rsquo;t be.</p><p>This is however, easier said then done when trying to do it with API Gateway and I&rsquo;ll show you why.</p><h2 id=api-gateway>API Gateway</h2><p>To start, let&rsquo;s have a look at Amazon API Gateway. When you create a gateway you&rsquo;ll be provided with an endpoint that is public by default and hosted under the Amazon domain (*.execute-api.{region}.amazonaws.com). This is not what we want, we want to have our API Gateway private and only accessible from within our VPC.</p><p>For Public API Gateways you can use a custom domain name and use Route 53 to point to the API Gateway endpoint. This is not possible for Private API Gateways, you can&rsquo;t use a custom domain name and you can&rsquo;t use Route 53 to point to the API Gateway endpoint.</p><p>When you deploy a simple API Gateway without any custom dns your architecture would look as simple as:</p><picture><source media="(min-width: 600px)" srcset=/2024/private-api-gateway-with-dns/1-api-gateway-lambda_hu_9366c570b1f5e01a.webp type=image/webp><source media="(min-width: 300px)" srcset=/2024/private-api-gateway-with-dns/1-api-gateway-lambda_hu_e7f46b779c6086a8.webp type=image/webp><source media="(max-width: 300px)" srcset=/2024/private-api-gateway-with-dns/1-api-gateway-lambda_hu_cd3e0ed4464e4182.webp type=image/webp><img loading=lazy src=/2024/private-api-gateway-with-dns/1-api-gateway-lambda_hu_fd73efb7a0816646.png alt="API Gateway with Lambda" width=100% height=422></picture><p>Now when you&rsquo;d like to add your own custom DNS on a public API Gateway you can do so by creating a custom domain name and using Route 53 to point to the API Gateway endpoint (you can leverage the <a href=https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html>custom domain feature on api</a>). This would look like:</p><picture><source media="(min-width: 600px)" srcset=/2024/private-api-gateway-with-dns/2-api-gateway-lambda-dns_hu_7c116ca938f8677e.webp type=image/webp><source media="(min-width: 300px)" srcset=/2024/private-api-gateway-with-dns/2-api-gateway-lambda-dns_hu_e8737bddf76b25b0.webp type=image/webp><source media="(max-width: 300px)" srcset=/2024/private-api-gateway-with-dns/2-api-gateway-lambda-dns_hu_4eec740ce289b47a.webp type=image/webp><img loading=lazy src=/2024/private-api-gateway-with-dns/2-api-gateway-lambda-dns_hu_c31dcefcbf85a0e3.png alt="API Gateway with Lambda and Custom DNS" width=100% height=489></picture><p>At this point it still looks simple, but when you&rsquo;d like to have a private API Gateway you can&rsquo;t use a custom domain name and you can&rsquo;t use Route 53 to point to the API Gateway endpoint. This is where it gets tricky.</p><h2 id=why-a-custom-domain>Why a custom domain?</h2><p>Even though it&rsquo;s not supported for Private API&rsquo;s you might wonder why would you need a custom domain on your API Gateway. To me there is a simple reason why I want this. Within a larger organization on AWS you often have other teams / aws accounts invoke your api&rsquo;s.</p><p>When you are in a situation like this often you have 2 options:</p><ul><li>There is a central team that manages all the api&rsquo;s and they provide you with the endpoint to invoke the api. (which still means that you need to provide a private network connection to the central API team).</li><li>You allow another team to invoke your api&rsquo;s by providing them with the endpoint of the api gateway.</li></ul><p>When you don&rsquo;t have custom dns on your API Gateway the only option to provide the API to a different account is to provide them with the API Gateway ID, which they&rsquo;ll use together with a VPC Endpoint in their account to reach your API Gateway. This is not a very user-friendly way to provide an API to another team.</p><picture><source media="(min-width: 600px)" srcset=/2024/private-api-gateway-with-dns/3-api-gateway-lambda-private-dns-vpce_hu_a2ccaa6df3ce6ec6.webp type=image/webp><source media="(min-width: 300px)" srcset=/2024/private-api-gateway-with-dns/3-api-gateway-lambda-private-dns-vpce_hu_a7422b52e9caf2d.webp type=image/webp><source media="(max-width: 300px)" srcset=/2024/private-api-gateway-with-dns/3-api-gateway-lambda-private-dns-vpce_hu_7b7f0d3accc45591.webp type=image/webp><img loading=lazy src=/2024/private-api-gateway-with-dns/3-api-gateway-lambda-private-dns-vpce_hu_b576888cc92d392e.png alt="API Gateway with Lambda and VPC Endpoint" width=100% height=312></picture><p>A downside of this is that you <em>lose</em> the flexibility to replace or update the API Gateway without having to update all the consumers that are using the API Gateway. When you have a custom domain name you can point the domain to a new API Gateway and the consumers don&rsquo;t have to change anything.</p><p>When you have a custom domain name you can provide the other team with a domain name that they can use to invoke the API Gateway. This is a much more user-friendly way to provide an API to another team.</p><h2 id=the-problem>The Problem</h2><p>As noted before it is not possible to use a custom domain name on a private API Gateway. This means that you can&rsquo;t use Route 53 to point to the API Gateway endpoint. The actual technical reason for me is still unknown but I do know that the API Gateway is not deployed inside your own VPC.</p><p>The only way to reach the API Gateway is by using a VPC Endpoint. This is a private connection between your VPC and the API Gateway. This is a great way to provide a private connection to the API Gateway but it doesn&rsquo;t provide you with a way to reach the API Gateway via a custom domain name.</p><h2 id=the-solution>The Solution</h2><p>The solution to this problem is to use an Application Load Balancer (ALB) in front of the VPC Endpoint. You will need to retrieve the private ip addresses of the VPC Endpoint and point a target group towards these. The ALB is deployed in your VPC and is reachable via a custom domain name. This way you can reach the API Gateway via the custom domain name and fully private net working.</p><p>The beauty of this solution is that you can provide the custom domain name to other teams and they can invoke the API Gateway via the custom domain name without having to know the specifics of the API Gateway. Because the consumer is now not aware of what is behind the DNS you can replace it with whatever you want without having to update the consumers.</p><p>This is how the architecture would look like:</p><picture><source media="(min-width: 600px)" srcset=/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb_hu_bf333bcd6b0f0695.webp type=image/webp><source media="(min-width: 300px)" srcset=/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb_hu_debb41b2bc458193.webp type=image/webp><source media="(max-width: 300px)" srcset=/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb_hu_611b453e880fdee.webp type=image/webp><img loading=lazy src=/2024/private-api-gateway-with-dns/4-api-gateway-lambda-private-dns-alb_hu_767569add9b85b3e.png alt="Private API Gateway with Lambda and Route53" width=100% height=278></picture><h2 id=cdk-example>CDK Example</h2><p>It&rsquo;s not a post from me without a CDK example, so here it is. In this example we are creating an API Gateway with a simple Mock Integration Response that is reachable via private DNS. The API Gateway is deployed in a VPC and is only reachable when invoked via the VPC Endpoint, to be able to use private DNS we are deploying an Application Load Balancer which is pointed towards the VPC Endpoint. Based upon the domain name that is pointed towards the Application Load Balancer and that is configured on the API Gateway we can reach the API Gateway via the private DNS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>const</span> apiFqn <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;api.cino.dev&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 1: Retrieve vpc / hosted zones
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> [vpc, publicHostedZone, privateHostedZone] <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.getNetwork();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 2: Create API Gateway VPC Endpoint
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> apiGatewayVpcEndpoint <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.createApiGatewayVpcEndpoint(vpc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 3: Create certificate for the API Gateway / ALB
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> acmCertificate <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.createCertificate(apiFqn, publicHostedZone);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 3: Create ALB
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> alb <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.createApplicationLoadBalancer(vpc, apiGatewayVpcEndpoint);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 4: Create API Gateway
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>this</span>.createApiGateway(apiFqn, acmCertificate, apiGatewayVpcEndpoint);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 5: Create ALB Listener for API Gateway VPC Endpoint
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>this</span>.createApiGatewayVpcEndpointListener(
</span></span><span style=display:flex><span>  acmCertificate,
</span></span><span style=display:flex><span>  vpc,
</span></span><span style=display:flex><span>  alb,
</span></span><span style=display:flex><span>  apiGatewayVpcEndpoint
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Step 6 Create Route53 records pointing towards
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// the Application Load Balancer
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>this</span>.createDnsRecords(privateHostedZone, alb, apiFqn);
</span></span></code></pre></div><p>As you see we need the following resources:</p><ul><li>VPC</li><li>Hosted Zones (Public & Private)<ul><li>Public Hosted Zone is used for the certificate</li><li>Private Hosted Zone is used for the DNS records</li></ul></li><li>API Gateway VPC Endpoint</li><li>Certificate for the API Gateway / ALB</li><li>Application Load Balancer<ul><li>Listener on port 443 for your domain pointing towards the VPC Endpoint Private IP Adresses</li></ul></li><li>API Gateway</li><li>Custom Domain Name pointing towards the Application Load Balancer</li></ul><p>For the full example you can visit the <a href=https://github.com/cino/cdk-examples/blob/main/private-api-gateway-dns/lib/private-api-gateway-dns-stack.ts>Github repository</a> as I&rsquo;ll only show you the most important parts of the code, that said we immediately go to step 5 where we create the API Gateway VPC Endpoint Listener.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>private</span> createApiGatewayVpcEndpointListener(
</span></span><span style=display:flex><span>  acmCertificate: <span style=color:#8be9fd>Certificate</span>,
</span></span><span style=display:flex><span>  vpc: <span style=color:#8be9fd>IVpc</span>,
</span></span><span style=display:flex><span>  alb: <span style=color:#8be9fd>ApplicationLoadBalancer</span>,
</span></span><span style=display:flex><span>  apiGatewayVpcEndpoint: <span style=color:#8be9fd>InterfaceVpcEndpoint</span>
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> <span style=color:#ff79c6>void</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> ipAddresses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.getVpcEndpointIpAddresses(
</span></span><span style=display:flex><span>    vpc,
</span></span><span style=display:flex><span>    apiGatewayVpcEndpoint
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> targets <span style=color:#ff79c6>=</span> ipAddresses.map((ip) <span style=color:#ff79c6>=&gt;</span> <span style=color:#ff79c6>new</span> IpTarget(ip));
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> apiGatewayTargetGroup <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ApplicationTargetGroup(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>`PrivateApiGatewayTargetGroup`</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      vpc: <span style=color:#8be9fd>vpc</span>,
</span></span><span style=display:flex><span>      targetType: <span style=color:#8be9fd>TargetType.IP</span>,
</span></span><span style=display:flex><span>      targetGroupName<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>`priv-apigw-tg`</span>,
</span></span><span style=display:flex><span>      targets,
</span></span><span style=display:flex><span>      protocol: <span style=color:#8be9fd>ApplicationProtocol.HTTPS</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  apiGatewayTargetGroup.configureHealthCheck({
</span></span><span style=display:flex><span>    path<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>`/test/hello`</span>,
</span></span><span style=display:flex><span>    healthyHttpCodes<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;200,403&#34;</span>,
</span></span><span style=display:flex><span>    port<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;443&#34;</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  alb.addListener(<span style=color:#f1fa8c>&#34;PrivateApiGatewayListener&#34;</span>, {
</span></span><span style=display:flex><span>    port: <span style=color:#8be9fd>443</span>,
</span></span><span style=display:flex><span>    protocol: <span style=color:#8be9fd>ApplicationProtocol.HTTPS</span>,
</span></span><span style=display:flex><span>    certificates<span style=color:#ff79c6>:</span> [acmCertificate],
</span></span><span style=display:flex><span>    defaultTargetGroups<span style=color:#ff79c6>:</span> [apiGatewayTargetGroup],
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>private</span> getVpcEndpointIpAddresses(
</span></span><span style=display:flex><span>  vpc: <span style=color:#8be9fd>IVpc</span>,
</span></span><span style=display:flex><span>  vpcEndpoint: <span style=color:#8be9fd>InterfaceVpcEndpoint</span>
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> <span style=color:#8be9fd>string</span>[] {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> vpcEndpointProps <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AwsCustomResource(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#34;VpcEndpointEnis&#34;</span>, {
</span></span><span style=display:flex><span>    onUpdate<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>      service<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;EC2&#34;</span>,
</span></span><span style=display:flex><span>      action<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;describeVpcEndpoints&#34;</span>,
</span></span><span style=display:flex><span>      parameters<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>        Filters<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            Name<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;vpc-endpoint-id&#34;</span>,
</span></span><span style=display:flex><span>            Values<span style=color:#ff79c6>:</span> [vpcEndpoint.vpcEndpointId],
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      physicalResourceId: <span style=color:#8be9fd>PhysicalResourceId.of</span>(<span style=color:#8be9fd;font-style:italic>Date</span>.now().toString()),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    policy: <span style=color:#8be9fd>AwsCustomResourcePolicy.fromSdkCalls</span>({
</span></span><span style=display:flex><span>      resources: <span style=color:#8be9fd>AwsCustomResourcePolicy.ANY_RESOURCE</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> vpcEndpointIps <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AwsCustomResource(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span>,
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;vpc-endpoint-ip-lookup&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      onUpdate<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>        service<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;EC2&#34;</span>,
</span></span><span style=display:flex><span>        action<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;describeNetworkInterfaces&#34;</span>,
</span></span><span style=display:flex><span>        outputPaths: <span style=color:#8be9fd>vpc.availabilityZones.map</span>((_, index) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>`NetworkInterfaces.</span><span style=color:#f1fa8c>${</span>index<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.PrivateIpAddress`</span>;
</span></span><span style=display:flex><span>        }),
</span></span><span style=display:flex><span>        parameters<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>          NetworkInterfaceIds: <span style=color:#8be9fd>vpc.availabilityZones.map</span>((_, index) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> vpcEndpointProps.getResponseField(
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>`VpcEndpoints.0.NetworkInterfaceIds.</span><span style=color:#f1fa8c>${</span>index<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>          }),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        physicalResourceId: <span style=color:#8be9fd>PhysicalResourceId.of</span>(<span style=color:#8be9fd;font-style:italic>Date</span>.now().toString()),
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      policy: <span style=color:#8be9fd>AwsCustomResourcePolicy.fromSdkCalls</span>({
</span></span><span style=display:flex><span>        resources: <span style=color:#8be9fd>AwsCustomResourcePolicy.ANY_RESOURCE</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> vpc.availabilityZones.map((_, index) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> vpcEndpointIps.getResponseField(
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>`NetworkInterfaces.</span><span style=color:#f1fa8c>${</span>index<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.PrivateIpAddress`</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The important part about this piece of code is we are creating a listener towards the private ip addresses of the created VPC Endpoint. This is done by creating a target group with the private ip addresses and creating a listener on the Application Load Balancer that points towards the target group.</p><p>However, the private ip addresses of the VPC Endpoint are not directly available in the CDK, so we need to use a Custom Resource to retrieve the private ip addresses of the VPC Endpoint. This is done by creating a Custom Resource that retrieves the VPC Endpoint ID and then creates another Custom Resource that retrieves the private ip addresses of the VPC Endpoint.</p><p>Full example can be found <a href=https://github.com/cino/cdk-examples/blob/main/private-api-gateway-dns/lib/private-api-gateway-dns-stack.ts>on GitHub</a>.</p><h2 id=conclusion>Conclusion</h2><p>In this post I&rsquo;ve shown you how you can create a private API Gateway with DNS. This is not a straightforward process and requires some additional resources to make it work. However, when you have a need for a private API Gateway with DNS this is the way to go.</p><p>Please have a good look at the Github link provided as there are a lot more details to be found and it is a fully working example with a simple <code>cdk deploy</code> command. (when you provide your own route53 / hosted zone)</p>I hope this post was helpful to you and if you have any questions or remarks feel free to reach out to me on <a href=https://bsky.app/profile/cino.io target=_blank>Bluesky</a> or <a href=https://www.linkedin.com/in/cinoricardo/ target=_blank>LinkedIn</a>.</div></article></div></div></div></div></div></div></main><footer class=mt-32><div class=sm:px-8><div class="mx-auto max-w-7xl lg:px-8"><div class="border-t border-zinc-100 pt-10 pb-16 0"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex gap-6 text-sm font-medium text-zinc-800"><a class="transition hover:text-teal-500" href=/>Home</a></div><p class="text-sm text-zinc-400">© 2025 Cino Consultancy<br><span class=text-xs>KVK: 89913019</span></p></div></div></div></div></div></div></footer></div></body></html>