<!doctype html><html class="h-full antialiased" style=--header-position:sticky;--content-offset:0px;--header-height:64px;--header-mb:0px;--header-top:0px;--avatar-top:0px lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Always set AWS CDK Defaults - Cino</title>
<link rel=canonical href=https://cino.io/2024/always-set-aws-cdk-defaults/><link rel=alternate type=application/rss+xml title=RSS href=https://cino.io/index.xml><link rel=icon type=image/png href=/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=/favicon.svg><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Cino.io"><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://cino.io/2024/always-set-aws-cdk-defaults/"><meta property="og:site_name" content="Cino"><meta property="og:title" content="Always set AWS CDK Defaults"><meta property="og:description" content="We are nearing the end of the year, the time to reflect on the past year and definitely share the things that went “wrong” or in this case the things that could have been done better. This is one of those things that I wish I knew earlier, and I hope it helps you too."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="2024"><meta property="article:published_time" content="2024-11-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-25T00:00:00+00:00"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Amazon Web Services"><meta property="article:tag" content="Tags/Cdk"><meta property="article:tag" content="Cloudformation"><meta property="article:tag" content="Tags/Kinesis"><meta property="article:tag" content="Tags/Removal Policy"><meta property="og:image" content="https://cino.io/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cino.io/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost.png"><meta name=twitter:title content="Always set AWS CDK Defaults"><meta name=twitter:description content="We are nearing the end of the year, the time to reflect on the past year and definitely share the things that went “wrong” or in this case the things that could have been done better. This is one of those things that I wish I knew earlier, and I hope it helps you too."><meta itemprop=name content="Always set AWS CDK Defaults"><meta itemprop=description content="We are nearing the end of the year, the time to reflect on the past year and definitely share the things that went “wrong” or in this case the things that could have been done better. This is one of those things that I wish I knew earlier, and I hope it helps you too."><meta itemprop=datePublished content="2024-11-25T00:00:00+00:00"><meta itemprop=dateModified content="2024-11-25T00:00:00+00:00"><meta itemprop=wordCount content="532"><meta itemprop=image content="https://cino.io/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost.png"><meta itemprop=keywords content="Aws,Amazon Web Services,Tags/Cdk,Cloudformation,Tags/Kinesis,Tags/Removal Policy,Tags/Cost"><link rel=stylesheet href="https://cino.io/css/styles.min.ec8f4583e891dc9fb7b5adeabaa94641c32b69ad9831a79f78289ae1f6fdf76c.css" integrity="sha256-7I9Fg+iR3J+3ta3quqlGQcMraa2YMaefeCia4fb992w="><meta name=fediverse:creator content="@cino@fosstodon.org"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GCGJ9S1XSX"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GCGJ9S1XSX")}</script></head><body class="flex h-full flex-col bg-zinc-50"><div class="fixed inset-0 flex justify-center sm:px-8"><div class="flex w-full max-w-7xl lg:px-8"><div class="w-full bg-white ring-1 ring-zinc-100"></div></div></div><div class=relative><header class="pointer-events-none relative z-50 flex flex-col" style=height:var(--header-height);margin-bottom:var(--header-mb)><div class="top-0 z-10 h-16 pt-6" style=position:var(--header-position)><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style=position:var(--header-inner-position)><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><a aria-label=Home class=pointer-events-auto href=https://cino.io/><img alt sizes=2.25rem src=/img/ricardo-cino-36x36.jpg decoding=async data-nimg=1 class="rounded-full bg-zinc-100 object-cover h-9 w-9" style=color:transparent width=512 height=512 alt="Ricardo Cino"></a></div></div><div class="flex flex-1 justify-end md:justify-center"><nav class="pointer-events-auto block"><ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><li><a class="relative block px-3 py-2 transition hover:text-teal-500" href=/>Home</a></li></ul></nav></div><div class="flex justify-end md:flex-1"></div></div></div></div></div></div></div></header><main><div class="sm:px-8 mt-16 lg:mt-32"><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class=xl:relative><div class="mx-auto max-w-2xl"><a href=/ aria-label="Go back to articles" class="group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:left-0 xl:mt-0"><svg viewBox="0 0 16 16" fill="none" aria-hidden="true" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400"><path d="M7.25 11.25 3.75 8m0 0 3.5-3.25M3.75 8h8.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a><article><header class="flex flex-col"><time datetime=2024-11-25 class="order-first flex items-center text-base text-zinc-400 dark:text-zinc-500"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>November 25, 2024</span>
<span class="h-4 ml-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>3 min read</span></time><div class="relative mt-4 text-zinc-400"><a href=/tags/aws class="hover:text-zinc-200 mr-2">aws</a>, <a href=/tags/amazon-web-services class="hover:text-zinc-200 mr-2">amazon web services</a>, <a href=/tags/cdk class="hover:text-zinc-200 mr-2">cdk</a>, <a href=/tags/cloudformation class="hover:text-zinc-200 mr-2">cloudformation</a>, <a href=/tags/kinesis class="hover:text-zinc-200 mr-2">kinesis</a>, <a href=/tags/removal-policy class="hover:text-zinc-200 mr-2">removal policy</a>, <a href=/tags/cost class="hover:text-zinc-200 mr-2">cost</a></div><h1 class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">Always set AWS CDK Defaults</h1></header><div class="mt-8 prose dark:prose-invert"><p>We are nearing the end of the year, the time to reflect on the past year and definitely share the things that went &ldquo;wrong&rdquo; or in this case the things that could have been done better. This is one of those things that I wish I knew earlier, and I hope it helps you too.</p><h2 id=aws-cdk-defaults-they-change>AWS CDK Defaults.. they change</h2><p>As you&rsquo;re reading this you definitely know what AWS CDK is and you are most likely also using it. If you are not, I&rsquo;d suggest you take a look at it, it&rsquo;s a great way to manage your AWS infrastructure in a programmatic way (nothing against the likes of Terraform and/or Pulumi, cdk is just my chosen evil (and mandated by the company)).</p><p>CDK is designed to be as user-friendly as possible, allowing you to create Amazon resources easily and quickly. To do so, it comes with a lot of defaults, which is great, but it can also be a bit risky.</p><p>Reason for me saying it are the following:</p><ul><li><p>I was not aware of the defaults, and I was not aware that the defaults of CDK are NOT the same as AWS CloudFormation</p></li><li><p>Defaults change, and they can change without you knowing it</p></li></ul><h2 id=what-happened>What happened?</h2><p>In the projects I work with we always have a full CI/CD setup with a lot of tests. For each pull-request we open we deploy a full environment with AWS CDK and run a lot of tests against it. This is great, and really helps us to catch a lot of issues before they hit production.</p><p>While deploying all the resource is great, we also need to destroy the resources that we created and this is where the issue started. Before a <a href=https://github.com/aws/aws-cdk/pull/30037>certain change in CDK</a> the default RemovalPolicy for Kinesis Stream was set to <code>DESTROY</code>, which is great for testing but not so great for production. After the change the default was set to <code>RETAIN</code>, which I support as for production you would want this.</p><p>However, because we were not setting the RemovalPolicy ourselves, we were relying on the default. This meant that after the change we were not able to delete the Kinesis Stream anymore, because the default was changed.</p><p>What surprised me about the change is that it was in a very large <a href=https://github.com/aws/aws-cdk/pull/30037>pull-request</a> where a lot of changes were made, and it was not mentioned in the release notes. This is not a critique, but it&rsquo;s just something to be aware of.</p><h2 id=how-did-i-find-out>How did I find out?</h2><p>You don&rsquo;t want to hear this, but yes, through the Cost Explorer. While randomly checking our Dev environment where the pull-request environments are deployed to there was a surprise peak in Kinesis cost, not being sure why I started digging into the resources and found out that many Kinesis streams were still there after Pull-Requests were closed.</p><picture><source media="(min-width: 600px)" srcset=/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost_hu2126543330832758052.webp type=image/webp><source media="(min-width: 300px)" srcset=/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost_hu6113057136934620474.webp type=image/webp><source media="(max-width: 300px)" srcset=/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost_hu10954643318375364524.webp type=image/webp><img loading=lazy src=/2024/always-set-aws-cdk-defaults/kinesis-removal-policy-change-cost_hu1146499909926568911.png alt="Kinesis cost spike" width=100% height=352></picture><h2 id=learnings>Learnings</h2><p>For me this taught me to always override the defaults of CDK, even if they are the same as the AWS defaults. This way you are sure that you are in control of the resources you are creating and you are not relying on the defaults of CDK. Giving you no surprises when a sudden change happens.</p></div></article></div></div></div></div></div></div></main><footer class=mt-32><div class=sm:px-8><div class="mx-auto max-w-7xl lg:px-8"><div class="border-t border-zinc-100 pt-10 pb-16 0"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex gap-6 text-sm font-medium text-zinc-800"><a class="transition hover:text-teal-500" href=/>Home</a></div><p class="text-sm text-zinc-400">© 2024 Cino Consultancy<br><span class=text-xs>KVK: 89913019</span></p></div></div></div></div></div></div></footer></div></body></html>