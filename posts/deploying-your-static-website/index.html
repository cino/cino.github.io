<!doctype html><html class="h-full antialiased" style=--header-position:sticky;--content-offset:0px;--header-height:64px;--header-mb:0px;--header-top:0px;--avatar-top:0px lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Deploying your static website with a Github Action - Cino</title><meta name=author content="Ricardo Cino"><meta name=generator content="Hugo 0.110.0"><link rel=stylesheet href="https://cino.io/css/styles.min.d47c9c0bedf94597c6c78a394b61d77b499b27eca8c09da8b1547aa28b208a63.css" integrity="sha256-1HycC+35RZfGx4o5S2HXe0mbJ+yowJ2osVR6oosgimM="></head><body class="flex h-full flex-col bg-zinc-50"><div class="fixed inset-0 flex justify-center sm:px-8"><div class="flex w-full max-w-7xl lg:px-8"><div class="w-full bg-white ring-1 ring-zinc-100"></div></div></div><div class=relative><header class="pointer-events-none relative z-50 flex flex-col" style=height:var(--header-height);margin-bottom:var(--header-mb)><div class="top-0 z-10 h-16 pt-6" style=position:var(--header-position)><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style=position:var(--header-inner-position)><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><a aria-label=Home class=pointer-events-auto href=https://cino.io/><img alt sizes=2.25rem src=/img/ricardo-cino.jpg decoding=async data-nimg=1 class="rounded-full bg-zinc-100 object-cover h-9 w-9" style=color:transparent width=512 height=512></a></div></div><div class="flex flex-1 justify-end md:justify-center"><nav class="pointer-events-auto block"><ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><li><a class="relative block px-3 py-2 transition hover:text-teal-500" href=/>Home</a></li><li><a class="relative block px-3 py-2 transition hover:text-teal-500" href=/about/>About</a></li></ul></nav></div><div class="flex justify-end md:flex-1"></div></div></div></div></div></div></div></header><main><div class="sm:px-8 mt-16 lg:mt-32"><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class=xl:relative><div class="mx-auto max-w-2xl"><a href=/ aria-label="Go back to articles" class="group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:left-0 xl:mt-0"><svg viewBox="0 0 16 16" fill="none" aria-hidden="true" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400"><path d="M7.25 11.25 3.75 8m0 0 3.5-3.25M3.75 8h8.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a><article><header class="flex flex-col"><h1 class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">Deploying your static website with a Github Action</h1><time datetime=2022-02-18 class="order-first flex items-center text-base text-zinc-400 dark:text-zinc-500"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>February 18, 2022</span>
<span class="h-4 ml-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>5 min read</span></time></header><div class="mt-8 prose dark:prose-invert"><p>Authenticate GitHub with OpenID Connect to deploy your CDK project to your AWS Organization</p><p>After making an AWS CDK project one of the first thing you will realize is that you don&rsquo;t want to keep running cdk deploy to update your production environment. This is a fine way of working when you modify your personal dev environment as it is a quick way of deploying but definitely not for your staging/production environments.</p><p>To deploy to these types of environments you should be using some kind of a ci/cd setup. There are lots of different tools you can choose from like <a href=https://aws.amazon.com/codedeploy/ target=_blank>AWS CodeDeploy,</a> <a href=https://docs.gitlab.com/ee/ci/pipelines/ target=_blank>GitLab Pipelines</a>, Jenkins (don&rsquo;t), or my absolute favorite at this moment <a href=https://github.com/features/actions target=_blank>Github Actions</a>.</p><p>When you think about how the deployment should work it&rsquo;s actually quite simple. The only thing that should happen is that the commands you&rsquo;re running by yourself should be run by an automated process. However, this is where we find our biggest problem: we are not authenticated in our GitHub Action (for now).</p><h2 id=how-to-authenticate-the-github-action>How to authenticate the GitHub Action?</h2><p>There is more than a single way to authenticate your GitHub action to manage your AWS resources, however, there is only one that is actually recommended by AWS. This is the OpenID Connect authentication method. When using this we authenticate GitHub to assume a role within an organization, when GitHub is authorized to do so it will request temporary credentials which can be used to execute command-line executions like the CDK.</p><p>The other option would be to generate long-loving access keys and store these in your repositories secrets, this is not the way you want to go and I&rsquo;m not sure why I&rsquo;m even telling this.</p><p><strong>ðŸ’¡ Avoid using Long-living-access keys completely, you don&rsquo;t want to deal with refreshing these keys in the long run.</strong></p><h2 id=setting-op-github-openid-connect-with-aws>Setting op Github OpenID Connect with AWS.</h2><p>Before we can make our GitHub Action which executes our deployment we will need to allow GitHub to our AWS Organization. This can be done by setting up an Identity Provider for GitHub within the IAM settings.</p><p>There is an excellent guide on how to configure the OpenID Identity Provider in the <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services target=_blank>GitHub documentation</a>. This includes all the information you should need to configure it correctly and make it work.</p><p>As shown in my earlier post about the <a href=/posts/static-website-distribution-with-aws-cloudfront/ target=_blank>static website</a> I find it important to have all my infrastructure as code, that&rsquo;s why I&rsquo;ll show how I&rsquo;ve configured the OpenID Connect Provider in a CDK Stack.</p><p>For starters, we would need to make an OpenID Connect Provider in AWS, this can be done with the IAM library of the CDK. As mentioned on the GitHub documentation you need to configure the URL and the &ldquo;Audience&rdquo;, when using the CDK you&rsquo;ll see there is no &ldquo;Audience&rdquo; property to configure. This is because this has been named &ldquo;clientIds&rdquo; and works the exact same.</p><p>Finally, we create an OpenIDConnectPrincipal which will allow GitHub to communicate with our AWS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>const</span> gitHubProvider <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> iam.OpenIdConnectProvider(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;GithubProvider&#39;</span>, {
</span></span><span style=display:flex><span>  url<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;https://token.actions.githubusercontent.com&#39;</span>,
</span></span><span style=display:flex><span>  clientIds<span style=color:#ff79c6>:</span> [<span style=color:#f1fa8c>&#39;sts.amazonaws.com&#39;</span>],
</span></span><span style=display:flex><span>  thumbprints<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;6938fd4d98bab03faadb97b34396831e3780aea1&#39;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> gitHubPrincipal <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> iam.OpenIdConnectPrincipal(gitHubProvider);</span></span></code></pre></div><p>The thumbprint is the latest according to this <a href=https://github.blog/changelog/2022-01-13-github-actions-update-on-oidc-based-deployments-to-aws/>GitHub blog</a> post.</p><p>Next up, we are going to define what roles GitHub can use, this is an important step as you want to explicitly tell when GitHub should be allowed to assume the given role.</p><p>Here we create a new role that includes an important condition, here we only allow GitHub to assume this role when the repository is my specific repository and even only from a specific branch. If you don&rsquo;t set this up correctly it could be possible someone else could enter your account.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>const</span> deploymentRole <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> iam.Role(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#34;DeploymentRole&#34;</span>, {
</span></span><span style=display:flex><span>  assumedBy: <span style=color:#8be9fd>new</span> iam.WebIdentityPrincipal(
</span></span><span style=display:flex><span>    gitHubProvider.openIdConnectProviderArn,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      StringLike<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;token.actions.githubusercontent.com:sub&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>          <span style=color:#f1fa8c>`repo:cino/cdk-static-serverless:ref:refs/heads/main`</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ),
</span></span><span style=display:flex><span>  managedPolicies<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>    iam.ManagedPolicy.fromAwsManagedPolicyName(<span style=color:#f1fa8c>&#34;AdministratorAccess&#34;</span>),
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>});</span></span></code></pre></div><p>Here you can see that we allow the OpenIdConnectProvider to assume the created role, and for this example, I&rsquo;ve given the role the AdministratorAccess role.</p><p><strong>ðŸ’¡ Don&rsquo;t give any role AdministratorAccess in production, this is only for the given example. You should create your own policy and specify exactly what you need to be able to accomplish.</strong></p><h2 id=creating-the-github-action-to-execute-the-deploy>Creating the Github Action to execute the deploy</h2><p>Now we have authenticated GitHub and can actually execute actions within our AWS account we can go ahead and create a GitHub action to deploy our existing Stack. For this, I&rsquo;ve updated the existing <a href=https://github.com/cino/cdk-static-serverless>Static Website</a> repository that I created during the previous blog post and made the action run. The complete action can be found at <a hreef=https://github.com/cino/cdk-static-serverless/blob/main/.github/workflows/deploy.yml>this location</a>.</p><p>We are lucky enough that the authentication part of our GitHub action has completely been automated by AWS and we simply need to use an existing GitHub action. This is the <a herf=https://github.com/aws-actions/configure-aws-credentials>aws-actions/configure-aws-credentials</a> action that can authenticate your action in multiple ways.</p><p>In our Action, we need to add the following part right after checking out our code and everything after this action will be authenticated to perform actions in the AWS Organization. As you can see we specify which role you want to assume and this needs to be the ARN of the created role.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Configure AWS credentials
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>uses</span>: aws-actions/configure-aws-credentials@v1
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>role-to-assume</span>: ${{ secrets.AWS_ROLE_TO_ASSUME }}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>aws-region</span>: eu-central-1</span></span></code></pre></div><p>Now we are authenticated we can do anything necessary to update our stack, for the given example I&rsquo;ve kept it as simple as possible to make it work by just setting up Node with the managed action from GitHub.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Setup Node
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>uses</span>: actions/setup-node@v2
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>node-version</span>: <span style=color:#bd93f9>14</span></span></span></code></pre></div><p>This will install node and npm in our action which we will need to install the dependencies which will be the next step.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Install dependencies
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>run</span>: npm ci
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: Deploy to CloudFront/S3
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>run</span>: npx cdk deploy --require-approval never</span></span></code></pre></div><p>These are the last 2 steps of our action, first, our npm dependencies are installed by running <code>npm ci</code>, and second, we will run the <code>cdk deploy</code> command by prefixing this with npx. Npx will download the CDK library and add it to our path so we can use the executable.</p><h2 id=thats-a-wrap>That&rsquo;s a wrap</h2><p>When all this has been set up you should be able to deploy the CDK project right into your AWS account while using a correct authentication method, without keys that you need to replace every x months. To see the results you can see the output of <a href="https://github.com/cino/cdk-static-serverless/runs/5272810000?check_suite_focus=true">this workflow</a> that is.</p></div></article></div></div></div></div></div></div></main><footer class=mt-32><div class=sm:px-8><div class="mx-auto max-w-7xl lg:px-8"><div class="border-t border-zinc-100 pt-10 pb-16 0"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex gap-6 text-sm font-medium text-zinc-800"><a class="transition hover:text-teal-500" href=/>Home</a>
<a class="transition hover:text-teal-500" href=/about/>About</a></div><p class="text-sm text-zinc-400">Â© 2023 Ricardo Cino. All rights reserved.</p></div></div></div></div></div></div></footer></div></body></html>