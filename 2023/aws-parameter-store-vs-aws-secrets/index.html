<!doctype html><html class="h-full antialiased" style=--header-position:sticky;--content-offset:0px;--header-height:64px;--header-mb:0px;--header-top:0px;--avatar-top:0px lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>AWS Parameter Store vs AWS Secrets - Cino</title>
<meta name=author content="Ricardo Cino"><meta name=generator content="Hugo 0.138.0"><meta property="og:title" content="AWS Parameter Store vs AWS Secrets - Cino"><meta property="twitter:title" content="AWS Parameter Store vs AWS Secrets - Cino"><meta property="og:url" content="https://cino.io/2023/aws-parameter-store-vs-aws-secrets/"><meta property="twitter:card" content="summary"><link rel=stylesheet href="https://cino.io/css/styles.min.156b16fc9c43a437fc827d807ca54f1e1a1f752c5f531be239eac2cd38e68bdf.css" integrity="sha256-FWsW/JxDpDf8gn2AfKVPHhofdSxfUxviOerCzTjmi98="><meta name=fediverse:creator content="@cino@fosstodon.org"><script async src="https://www.googletagmanager.com/gtag/js?id=G-GCGJ9S1XSX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GCGJ9S1XSX")</script></head><body class="flex h-full flex-col bg-zinc-50"><div class="fixed inset-0 flex justify-center sm:px-8"><div class="flex w-full max-w-7xl lg:px-8"><div class="w-full bg-white ring-1 ring-zinc-100"></div></div></div><div class=relative><header class="pointer-events-none relative z-50 flex flex-col" style=height:var(--header-height);margin-bottom:var(--header-mb)><div class="top-0 z-10 h-16 pt-6" style=position:var(--header-position)><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style=position:var(--header-inner-position)><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><a aria-label=Home class=pointer-events-auto href=https://cino.io/><img alt sizes=2.25rem src=/img/ricardo-cino-36x36.jpg decoding=async data-nimg=1 class="rounded-full bg-zinc-100 object-cover h-9 w-9" style=color:transparent width=512 height=512></a></div></div><div class="flex flex-1 justify-end md:justify-center"><nav class="pointer-events-auto block"><ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur"><li><a class="relative block px-3 py-2 transition hover:text-teal-500" href=/>Home</a></li></ul></nav></div><div class="flex justify-end md:flex-1"></div></div></div></div></div></div></div></header><main><div class="sm:px-8 mt-16 lg:mt-32"><div class="mx-auto max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class=xl:relative><div class="mx-auto max-w-2xl"><a href=/ aria-label="Go back to articles" class="group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10 dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5 lg:mb-0 lg:-mt-2 xl:-top-1.5 xl:left-0 xl:mt-0"><svg viewBox="0 0 16 16" fill="none" aria-hidden="true" class="h-4 w-4 stroke-zinc-500 transition group-hover:stroke-zinc-700 dark:stroke-zinc-500 dark:group-hover:stroke-zinc-400"><path d="M7.25 11.25 3.75 8m0 0 3.5-3.25M3.75 8h8.5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a><article><header class="flex flex-col"><h1 class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">AWS Parameter Store vs AWS Secrets</h1><time datetime=2023-07-19 class="order-first flex items-center text-base text-zinc-400 dark:text-zinc-500"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>July 19, 2023</span>
<span class="h-4 ml-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
<span class=ml-3>9 min read</span></time></header><div class="mt-8 prose dark:prose-invert"><p>Recently I&rsquo;ve been using AWS Secrets to retrieve API keys which are needed to access external API&rsquo;s, however, this turned out to be a more expensive service than we initially thought when starting.</p><img src=/img/2023/aws-parameter-store-vs-secrets/secrets-vs-parameter-store.png><h2 id=parameter-store-vs-secrets>Parameter Store vs Secrets</h2><p>When you need to store and use variables/secrets within AWS, you&rsquo;ll have several services at your disposal to ensure secure and efficient management. The two primary services for this purpose are AWS Systems Manager Parameter Store and AWS Secrets Manager. AWS Systems Manager Parameter Store is ideal for storing non-sensitive configuration data, such as database connection strings and application settings. It offers both plaintext and encrypted options, along with basic access control using IAM policies.</p><p>On the other hand, AWS Secrets Manager is specifically designed to handle sensitive information like API keys, database credentials, and other secrets. It automatically encrypts the data using AWS KMS and provides more granular access control through IAM policies, even allowing for secret rotation to enhance security. By choosing the appropriate service for your specific use case, you can ensure the protection of your variables and secrets while seamlessly integrating them into your AWS applications and services.</p><p>However, if you look at the encrypted option for Parameter Store and compare it with Secrets you&rsquo;ll quickly realize that when you <strong>don&rsquo;t&rsquo;</strong> make use of the rotation feature in AWS Secrets it is actually a very expensive Parameter Store.</p><p><em>All the code examples on this page are available as ready-to-deploy cdk on my <a href=https://github.com/cino/cdk-examples/tree/main/parameter-store-vs-secret target=_blank>CDK Examples</a> repository.</em></p><h2 id=why-use-parameter-store>Why use Parameter Store?</h2><p>The Parameter Store is a service that is used to store variables and secrets, it is a very simple service to use and it is very cheap. The Parameter Store is a service that is part of the AWS Systems Manager, this is a great place to store variables that you want to use in your code but don&rsquo;t want to hardcore. For example you could store the API key of a external service in the Parameter Store and retrieve it in your code, another example could be the identifiers/keys for specific resources in your AWS account.</p><p>Because you can retrieve this during rungtime (and cache them for limited time) you always the latest version of the parameter, compared to storing such values in Lambda Environments or in a file on the EC2 instance.</p><h2 id=when-to-use-aws-secrets>When to use AWS Secrets?</h2><p>What makes AWS Secrets such a powerfool tool is that it seamlessly integrates with a couple of Amazon products, for example you can easily use an AWS Secret to rotate the password of your Aurora instance without writing a single line of code. A couple of AWS Services that are supported by this are: Amazon RDS, Amazon DocumentDB and Amazon Redshift. Next to the out-of-the-box support services AWS also provides with a few rotation lambda templates on their <a href=https://github.com/aws-samples/aws-secrets-manager-rotation-lambdas/tree/master target=_blank>GitHub</a>.</p><p>In the case of a custom secret the only time to use AWS Secrets would be when you actually are rotating the values on a regular basis, the mechanism provided by Amazon is amazing and with automatic failure handling/retry handling it works better than with the Parameter Store.</p><p>For any secret you are not rotating I would advise to use the Parameter Store as this is much cheaper when you are using it a lot.</p><h2 id=but-you-can-also-rotate-the-value-with-parameter-store>But&mldr; you can also rotate the value with Parameter Store.</h2><p>Absolutely! This would however be a complete custom integration with a scheduled lambda that modifies the value of the Parameter. In fact this is the same thing that you do when using the Rotation feature of AWS Secrets except it is much more simplified. For starters you would need to deploy a Lambda Function with the permissions to read and write to the specific Parameter.</p><p>CDK:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>const</span> secretParameter <span style=color:#ff79c6>=</span> StringParameter.fromSecureStringParameterAttributes(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;mySecretRotatingParameter&#39;</span>, {
</span></span><span style=display:flex><span>  parameterName<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;/parameter-store-vs-secret/secret-rotating&#39;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// It is not possible to get the output of the secret value from the AWS CDK.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// However you can give lambda&#39;s permission to read/write the secret value.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// In this example we will be rotating the secret every 5 minutes to demonstrate the rotation.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> rotationLambda <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NodejsFunction(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;rotationLambda&#39;</span>, {
</span></span><span style=display:flex><span>  entry: <span style=color:#8be9fd>join</span>(__dirname, <span style=color:#f1fa8c>&#39;./custom-rotation/main.ts&#39;</span>),
</span></span><span style=display:flex><span>  environment<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>    PARAMETER_NAME: <span style=color:#8be9fd>secretParameter.parameterName</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  runtime: <span style=color:#8be9fd>Runtime.NODEJS_18_X</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>secretParameter.grantRead(rotationLambda);
</span></span><span style=display:flex><span>secretParameter.grantWrite(rotationLambda);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Schedule the rotation every 5 minutes using a CloudWatch Event Rule.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>new</span> Rule(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;rotationRule&#39;</span>, {
</span></span><span style=display:flex><span>  schedule: <span style=color:#8be9fd>Schedule.rate</span>(Duration.minutes(<span style=color:#bd93f9>5</span>)),
</span></span><span style=display:flex><span>  targets<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>new</span> LambdaFunction(rotationLambda),
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><em>Source: <a href=https://github.com/cino/cdk-examples/blob/main/parameter-store-vs-secret/lib/parameter-store-secret-custom-rotation-stack.ts target=_blank>parameter-store-secret-custom-rotation-stack.ts</a></em></p><p>Lambda:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>const</span> handler: <span style=color:#8be9fd>ScheduledHandler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>async</span> (
</span></span><span style=display:flex><span>  event: <span style=color:#8be9fd>ScheduledEvent</span>,
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> parameterName <span style=color:#ff79c6>=</span> process.env.PARAMETER_NAME <span style=color:#ff79c6>as</span> <span style=color:#8be9fd>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>await</span> ssmClient.send(<span style=color:#ff79c6>new</span> PutParameterCommand({
</span></span><span style=display:flex><span>    Name: <span style=color:#8be9fd>parameterName</span>,
</span></span><span style=display:flex><span>    Value: <span style=color:#8be9fd>new</span> <span style=color:#8be9fd;font-style:italic>Date</span>().toISOString(),
</span></span><span style=display:flex><span>    Overwrite: <span style=color:#8be9fd>true</span>,
</span></span><span style=display:flex><span>  }));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is however an extremely simplified version as this would only set the value to the latest date, in a real world example you could first generate an API key in a external service by calling an API and directly after that update the value in the Secure Parameter.</p><h2 id=secret-rotation-example>Secret Rotation Example</h2><p>In the case of AWS Secrets there is a specific feature that allows you to rotate the value of the secret, this is a very powerful feature that allows you to rotate the value of the secret without having to write any code. In the case of a custom secret you would need to write a custom lambda that would rotate the value of the secret, this is a lot more work than using the AWS Secrets Manager.</p><p>In the case of a custom secret I&rsquo;ve created an example lambda that I&rsquo;ve made available in a <a href=https://github.com/cino/typescript-lambda-examples/blob/main/src/secret-manager-rotation.ts target=_blank>special repository</a> and will also show below, first of all setting this up via CDK is very easy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>const</span> customSecret <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Secret(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;customSecret&#39;</span>, {
</span></span><span style=display:flex><span>  secretName<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;/parameter-store-vs-secret/secret-rotation-custom&#39;</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>customSecret.addRotationSchedule(<span style=color:#f1fa8c>&#39;RotationSchedule&#39;</span>, {
</span></span><span style=display:flex><span>  rotationLambda: <span style=color:#8be9fd>new</span> NodejsFunction(<span style=color:#ff79c6>this</span>, <span style=color:#f1fa8c>&#39;rotationLambda&#39;</span>, {
</span></span><span style=display:flex><span>    entry: <span style=color:#8be9fd>join</span>(__dirname, <span style=color:#f1fa8c>&#39;./custom-rotation-secret/main.ts&#39;</span>),
</span></span><span style=display:flex><span>    architecture: <span style=color:#8be9fd>Architecture.ARM_64</span>,
</span></span><span style=display:flex><span>    runtime: <span style=color:#8be9fd>Runtime.NODEJS_18_X</span>,
</span></span><span style=display:flex><span>    timeout: <span style=color:#8be9fd>Duration.seconds</span>(<span style=color:#bd93f9>30</span>),
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>  automaticallyAfter: <span style=color:#8be9fd>Duration.days</span>(<span style=color:#bd93f9>1</span>),
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Instead of the need to create a seperate CloudWatch Event Rule and Lambda Function you can simply add the rotation schedule to the secret. This will automatically create the CloudWatch Event Rule and Lambda Function for you with the correct permissions to be able to retrieve/store the secret.</p><p>The lambda function will actually be a bit more complex than with the Parameter Store as there are 4 different events that you need to handle, these are:</p><ul><li>createSecret<ul><li>This event is triggered at the start of the process where a new version of the secret will be created with a new value. This can either be generated or retrieved from a external service.</li></ul></li><li>setSecret<ul><li>This event is triggered after the createSecret event and will be the phase where you would persist the secret value in a external service to be able to authenticate with it.</li></ul></li><li>testSecret<ul><li>After setting the secret in the external service you will need to test if the secret is valid, this is done by calling the external service with the new secret value and see if the authentication is done properly. Additionally you can also include some extra authorization checks.</li></ul></li><li>finishSecret<ul><li>The last and final step is where you would change the state of the new secret to &lsquo;AWSCURRENT&rsquo; and remove the old version of the secret, only in this step, after the testing phase the new secret will be used.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> createSecret(
</span></span><span style=display:flex><span>  arn: <span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span>  token: <span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Check if the current version exists
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>new</span> GetSecretValueCommand({
</span></span><span style=display:flex><span>      SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>      VersionStage<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;AWSCURRENT&#39;</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Check if the pending version exists otherwise create a new one
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>new</span> GetSecretValueCommand({
</span></span><span style=display:flex><span>        SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>        VersionStage<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;AWSPENDING&#39;</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    console.log(<span style=color:#f1fa8c>`Secret version </span><span style=color:#f1fa8c>${</span>token<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> already exists for secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff79c6>catch</span> (exception) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Here we would create a new secret / create a new API key in an external service and create a new secret version.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * For this demo purpose we are going to create a new secret version with a random string
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> randomString <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>Math</span>.random().toString(<span style=color:#bd93f9>36</span>).substring(<span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>15</span>) <span style=color:#ff79c6>+</span> <span style=color:#8be9fd;font-style:italic>Math</span>.random().toString(<span style=color:#bd93f9>36</span>).substring(<span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>15</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// If the current version does not exist, create a new one
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>new</span> PutSecretValueCommand({
</span></span><span style=display:flex><span>        SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>        ClientRequestToken: <span style=color:#8be9fd>token</span>,
</span></span><span style=display:flex><span>        SecretString: <span style=color:#8be9fd>randomString</span>,
</span></span><span style=display:flex><span>        VersionStages<span style=color:#ff79c6>:</span> [<span style=color:#f1fa8c>&#39;AWSPENDING&#39;</span>],
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    console.log(<span style=color:#f1fa8c>`Secret version </span><span style=color:#f1fa8c>${</span>token<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> created for secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> setSecret()<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   * Set the secret in the external application / service unless the token has been generated
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   * by the previous step by using an api.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   */</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> testSecret()<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   * Test if the secret is working and the correct permissions are set in the external application / service
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>   */</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> finishSecret(
</span></span><span style=display:flex><span>  arn: <span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span>  token: <span style=color:#8be9fd>string</span>,
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> metaData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>new</span> DescribeSecretCommand({
</span></span><span style=display:flex><span>      SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Check if the current version is already set correctly and stop the process.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#8be9fd;font-style:italic>let</span> currentVersion: <span style=color:#8be9fd>string</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>undefined</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>undefined</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (metaData.VersionIdsToStages) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> version <span style=color:#ff79c6>in</span> metaData.VersionIdsToStages) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (metaData.VersionIdsToStages[version].includes(<span style=color:#f1fa8c>&#39;AWSCURRENT&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (version <span style=color:#ff79c6>===</span> token) {
</span></span><span style=display:flex><span>          console.log(<span style=color:#f1fa8c>`Version </span><span style=color:#f1fa8c>${</span>version<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> is already set as AWSCURRENT for secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>)
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        currentVersion <span style=color:#ff79c6>=</span> version;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// If not finialize the secret rotation process
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>new</span> UpdateSecretVersionStageCommand({
</span></span><span style=display:flex><span>      SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>      VersionStage<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;AWSCURRENT&#39;</span>,
</span></span><span style=display:flex><span>      MoveToVersionId: <span style=color:#8be9fd>token</span>,
</span></span><span style=display:flex><span>      RemoveFromVersionId: <span style=color:#8be9fd>currentVersion</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  console.log(<span style=color:#f1fa8c>&#39;Secret rotation process finished&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>const</span> handler: <span style=color:#8be9fd>SecretsManagerRotationHandler</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>async</span> (
</span></span><span style=display:flex><span>  event: <span style=color:#8be9fd>SecretsManagerRotationEvent</span>,
</span></span><span style=display:flex><span>)<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>void</span>&gt; <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>  console.log(JSON.stringify(event));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> arn <span style=color:#ff79c6>=</span> event.SecretId;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> token <span style=color:#ff79c6>=</span> event.ClientRequestToken;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> step <span style=color:#ff79c6>=</span> event.Step;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> metadata <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> secretsClient.send(
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>new</span> DescribeSecretCommand({
</span></span><span style=display:flex><span>      SecretId: <span style=color:#8be9fd>arn</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (metadata.RotationEnabled <span style=color:#ff79c6>!==</span> <span style=color:#ff79c6>true</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> is not enabled for rotation`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> versions <span style=color:#ff79c6>=</span> metadata.VersionIdsToStages;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (versions) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (token <span style=color:#ff79c6>in</span> versions <span style=color:#ff79c6>===</span> <span style=color:#ff79c6>false</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Secret version </span><span style=color:#f1fa8c>${</span>token<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> has no stage for rotation of secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (versions[token].includes(<span style=color:#f1fa8c>&#39;AWSCURRENT&#39;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Secret version </span><span style=color:#f1fa8c>${</span>token<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> already set as AWSCURRENT for secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (versions[token].includes(<span style=color:#f1fa8c>&#39;AWSPENDING&#39;</span>) <span style=color:#ff79c6>===</span> <span style=color:#ff79c6>false</span> <span style=color:#ff79c6>&amp;&amp;</span> step <span style=color:#ff79c6>!==</span> <span style=color:#f1fa8c>&#34;createSecret&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Secret version </span><span style=color:#f1fa8c>${</span>token<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> not set as AWSPENDING for rotation of secret </span><span style=color:#f1fa8c>${</span>arn<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>switch</span> (step) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;createSecret&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>await</span> createSecret(arn, token);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;setSecret&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>await</span> setSecret();
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;testSecret&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>await</span> testSecret();
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;finishSecret&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>await</span> finishSecret(arn, token);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Unsupported step &#34;</span><span style=color:#f1fa8c>${</span>step<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=pricing>Pricing</h2><p>Here we go, with AWS it&rsquo;s always about pricing. Especially since there is a <a href=https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/welcome.html target=_blank>specific pillar</a> about it. So let&rsquo;s take a look at the pricing of both services.</p><table><tr><td><strong>Service</strong></td><td><strong>Count</strong></td><td><strong>Requests</strong></td><td><strong>Price</strong></td></tr><tr><td>Parameter Store</td><td>25</td><td>10,000</td><td>$0.00</td></tr><tr><td>Secrets</td><td>25</td><td>10,000</td><td>$10.05</td></tr></table><p>As you can see in the comparison calculated by <a href=https://calculator.aws target=_blank>calculator.aws</a> the Parameter Store is a lot cheaper than the Secrets Manager. This is because the Secrets Manager is a lot more feature rich and has a lot more functionality than the Parameter Store. However, if you are not using the rotation feature of the Secrets Manager you are paying a lot more for the same functionality.</p></div></article></div></div></div></div></div></div></main><footer class=mt-32><div class=sm:px-8><div class="mx-auto max-w-7xl lg:px-8"><div class="border-t border-zinc-100 pt-10 pb-16 0"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex gap-6 text-sm font-medium text-zinc-800"><a class="transition hover:text-teal-500" href=/>Home</a></div><p class="text-sm text-zinc-400">© 2024 Cino Consultancy<br><span class=text-xs>KVK: 89913019</span></p></div></div></div></div></div></div></footer></div></body></html>